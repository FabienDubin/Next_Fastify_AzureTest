# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - api-testazure-prod

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'packages/shared/**'
      - '.github/workflows/main_api-testazure-prod.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @repo/shared build

      - name: Generate Prisma Client
        run: pnpm --filter backend run prisma:generate

      - name: Build backend
        run: pnpm --filter backend build

      - name: Create standalone deployment folder
        run: |
          mkdir -p deploy/dist
          mkdir -p deploy/prisma
          mkdir -p deploy/node_modules/@repo/shared
          mkdir -p deploy/node_modules/.prisma
          mkdir -p deploy/node_modules/@prisma

          # Copy built files
          cp -r apps/backend/dist/* deploy/dist/
          cp -r apps/backend/prisma/* deploy/prisma/

          # Copy shared package (compiled with dist folder)
          cp -r packages/shared/dist deploy/node_modules/@repo/shared/
          cp packages/shared/package.json deploy/node_modules/@repo/shared/

          # Copy Prisma Client (generated at root node_modules by pnpm)
          cp -r node_modules/.prisma/* deploy/node_modules/.prisma/
          cp -r node_modules/@prisma/client deploy/node_modules/@prisma/

          # Copy backend package.json and remove workspace dependency
          cp apps/backend/package.json deploy/package.json

          # Remove @repo/shared from dependencies and build script (already built)
          cd deploy
          node -e "const pkg = require('./package.json'); delete pkg.dependencies['@repo/shared']; delete pkg.scripts.postinstall; pkg.scripts.build = 'echo \"Already built\"'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

          # Install dependencies with npm (flat structure, no symlinks)
          npm install --omit=dev --ignore-scripts

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: deploy/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'api-testazure-prod'
          slot-name: 'Production'
          package: .
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_2BB1BD2D787B4D028285269A2A1ABE72 }}
